{% extends "base_template.html" %}

{% block title %}{{ dataset.ds_meta_data.title or "Dataset Tabular" }}{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Título -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">{{ dataset.ds_meta_data.title if dataset.ds_meta_data else "Dataset Tabular" }}</h2>
    <a href="{{ url_for('dataset.list_dataset') }}" class="btn btn-outline-secondary btn-sm">
      <i data-feather="arrow-left"></i> Volver
    </a>
  </div>

  <!-- Descripción -->
  {% if dataset.ds_meta_data and dataset.ds_meta_data.description %}
    <p class="text-muted">{{ dataset.ds_meta_data.description }}</p>
  {% endif %}

  <!-- Metadatos -->
  {% if meta %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Información general</h5>
        <p class="mb-1">
          <b>Filas:</b> {{ meta.n_rows or "Desconocido" }}<br>
          <b>Columnas:</b> {{ meta.n_cols or "Desconocido" }}<br>
          <b>Delimitador:</b> <code>{{ meta.delimiter or "," }}</code><br>
          <b>Cabecera:</b> {{ "Sí" if meta.has_header else "No" }}<br>
          <b>Codificación:</b> {{ meta.encoding or "utf-8" }}
        </p>
      </div>
    </div>
  {% endif %}

  <!-- Vista previa -->
  {% if meta and meta.sample_rows %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Vista previa ({{ meta.sample_rows|length }} filas)</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-sm align-middle text-center">
            {% if meta.has_header %}
              <thead class="table-light">
                <tr>
                  {% for cell in meta.sample_rows[0] %}
                    <th scope="col">{{ cell }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in meta.sample_rows[1:] %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            {% else %}
              <tbody>
                {% for row in meta.sample_rows %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            {% endif %}
          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-warning">No hay filas de muestra disponibles para este dataset.</div>
  {% endif %}

  <!-- Métricas opcionales -->
  {% if dataset.metrics %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Métricas de calidad</h5>
        <p class="mb-0">
          <b>Ratio de nulos:</b> {{ "%.2f"|format(dataset.metrics.null_ratio * 100) if dataset.metrics.null_ratio else "N/A" }}%<br>
          <b>Cardinalidad media:</b> {{ dataset.metrics.avg_cardinality or "N/A" }}
        </p>
      </div>
    </div>
  {% endif %}

  {% if dataset.polymorphic_identity == 'tabular' and dataset.get_csv_path() %}
    <div class="mt-3">
        <h5>Archivo CSV asociado</h5>
        <a href="{{ url_for('tabular.download_csv', dataset_id=dataset.id) }}"
           class="btn btn-outline-primary btn-sm">
           <i data-feather="download"></i> Descargar CSV
        </a>
    </div>
  {% endif %}


  <!-- Enlace de descarga -->
  <div class="mt-4 text-end">
    <a href="{{ url_for('dataset.download_dataset', dataset_id=dataset.id) }}" class="btn btn-primary">
      <i data-feather="download"></i> Descargar CSV
    </a>
  </div>

</div>
{% endblock %}
