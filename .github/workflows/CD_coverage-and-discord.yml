name: Test & Coverage

on:
  push:
    branches: 
      - main

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install rosemary

      - name: Run tests with coverage
        run: |
          rosemary coverage --html

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: htmlcov
          path: htmlcov/
          retention-days: 7

      - name: Extract coverage percent
        id: cov
        run: |
          # Rosemary genera un archivo .coverage y un HTML.
          # El HTML contiene una lÃ­nea con: "coverage: XX%"
          COV=$(grep -oP 'coverage[^0-9]*\K[0-9]+' htmlcov/index.html | head -1)
          echo "coverage=$COV" >> $GITHUB_OUTPUT

  notify-discord:
    needs: test-and-coverage
    runs-on: ubuntu-latest

    steps:
      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COVERAGE: ${{ needs.test-and-coverage.outputs.coverage }}
        run: |
          JSON_PAYLOAD='{
            "content": "ðŸ§ª **Cobertura generada tras push a main**\nRepositorio: '"$REPO"'\nCobertura: '"$COVERAGE"'%\nArtifact: '"$RUN_URL"'"
          }'

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK"
