name: Contributor Stats

on:
  push:
    branches:
      - trunk
  workflow_dispatch: {}

jobs:
  stats:
    name: Compute contributor stats
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Compute lines contributed per author
        run: |
          git fetch --all --prune
          echo "# Lines contributed per author (additions)" > contributor_stats.txt
          git log --no-merges --numstat --pretty=format:"==%aN" | \
            awk -F"\t" '
              /^==/ {author=substr($0,3); next}
              NF>=3 {add=$1; if(add=="-") add=0; adds[author]+=add}
              END {for (a in adds) print adds[a] "\t" a}' | sort -nr >> contributor_stats.txt
          echo "" >> contributor_stats.txt

      - name: Compute issues closed per contributor (using GH API)
        env:
          REPO: EGCRubik/rubik-hub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Issues closed per user" >> contributor_stats.txt
          # Use GitHub API to list closed issues and count closed_by
          gh api --paginate repos/${REPO}/issues -F state=closed --jq '.[] | .closed_by.login' \
            | sed '/^null$/d' | sort | uniq -c | sort -nr >> contributor_stats.txt || true
          echo "" >> contributor_stats.txt

      - name: Upload stats artifact
        uses: actions/upload-artifact@v4
        with:
          name: contributor_stats
          path: contributor_stats.txt

      - name: Print stats to log
        run: |
          echo "---- contributor_stats.txt ----"
          cat contributor_stats.txt
